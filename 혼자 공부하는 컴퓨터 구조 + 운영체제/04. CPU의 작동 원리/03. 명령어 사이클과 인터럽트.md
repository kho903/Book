# 명령어 사이클과 인터럽트
- 명령어 사이클 : CPU가 하나의 명령어를 처리하는 정형화된 흐름
- 인터럽트 : 정해진 흐름에 따라 명령어를 처리해 나가지만, 간혹 이 흐름이 끊어지는 상황

## 명령어 사이클
- 프로그램 속 각각의 명령어들은 일정한 주기가 반복되며 실행되는데, 이 주기를 명령어 사이클이라고 한다.
- 명령어 사이클은 인출, 실행, 간접, 인터럽트 사이클로 구성되어 있다.
- 명령어 사이클의 첫 번째 과정은 명령어를 메모리에서 CPU로 가져와야 한다. 이 단계를 인출 사이클이라고 한다.
- 두 번째 과정은 CPU로 가져온 명령어를 실행하는 단계로 실행 사이클이라고 한다. 제어장치가 명령어 레지스터에 담긴 값을 해석하고, 제어 신호를 발생시키는 단계.
- 프로그램을 이루는 수많은 명령어는 일반적으로 인출, 실행 사이클을 반복하여 실행된다. 하지만 모든 명령어가 이렇게 간단하게 실행되지는 않는다.
- 예를 들어 간접 주소 지정 방식처럼 명령어를 인출하여 CPU로 가져와도 바로 실행할 수 없고, 메모리 접근을 한 번 더해야 하기 때문이다. 이 단계를 간접 사이클이라고 한다.
- 여기서 한 가지 더 고려해야 할 것은 인터럽트이다.

## 인터럽트
- 인터럽트는 interrupt '방해하다, 중단시키다'를 의미. CPU가 수행 중인 작업은 방해를 받아 잠시 중단될 수 있는데, 이렇게 CPU의 작업을 방해하는 신호.
- 크게 동기 인터럽트와 비동기 인터럽트가 있다.
- 동기 인터럽트는 CPU에 의해 발생하는 인터럽트로, 예상치 못한 상황에 마주쳤을 때, 가령 프로그래밍상 오류와 같은 예외적 상황에서 발생하는 인터럽트. 
따라서 예외(exception)라고도 부름.
- 비동기 인터럽트는 주로 입출력장치에 의해 발생하는 인터럽트로, 세탁기 완료 알림, 전자레인지 조리 완료 알림 역할.
  - CPU가 프린터에 입출력 작업을 부탁하면 작업 끝낸 프린터가 CPU에 완료 알림(인터럽트)를 보낸다.
  - 키보드, 마우스가 어떠한 입력을 받아들였을 때 이를 처리하기 위해 CPU에 입력 알림(인터럽트)를 보낸다.
- 일반적으로 비동기 인터럽트를 인텁트라 칭하기도 하지만 하드웨어 인터럽트라고 한다.

### 하드웨어 인터럽트
- 하드웨어 인터럽트는 알림과 같은 인터럽트로 CPU는 입출력 작업 도중에도 효율적으로 명령어를 처리하기 위해 사용.
- 하드웨어 인터럽트를 이용하면 CPU는 주기적으로 입출력장치의 작업 완료 여부를 확인할 필요가 없이 완료 인터럽트를 받을때까지 다른 작업을 처리할 수 있다.
- 이렇듯 입출력 작업 중에도 CPU로 하여금 효율적으로 명령어를 처리할 수 있게 한다.

### 하드웨어 인터럽트 처리 순서
1. 입출력장치는 CPU에 인터럽트 요청 신호를 보냄.
2. CPU는 실행 사이클이 끝나고 명령어를 인출하기 전 항상 인터럽트 여부를 확인.
3. CPU는 인터럽트 요청을 확인하고 인터럽트 플래그를 통해 현재 인터럽트를 받아들일 수 있는 지 여부를 확인.
4. 인터럽트를 받아들일 수 있다면 CPU는 지금까지의 작업을 백업.
5. CPU는 인터럽트 벡터를 참조하여 인터럽트 서비스 루틴을 실행.
6. 인터럽트 서비스 루틴 실행이 끝나면 4에서 백업해 둔 작업을 복구하여 실행을 재개.
- 인터럽트는 CPU의 정상적인 실행 흐름을 끊는 것이므로 다른 누군가가 인터럽트하기 전에는 "지금 끼어들어도 되나요?"하고 CPU에게 물어봐야 하는데,
이를 인터럽트 요청 신호라고 한다.
- CPU의 인터럽트 요청 수용 위한 플래그 레지스터의 인터럽트 플래그가 활성화되어 있어야 한다. 인터럽트 플래그는 하드웨어 인터럽트를 받아들일지, 무시할지 결정하는 플래그.
  - CPU가 중요한 작업을 처리해야 하거나 방해받으면 안 될때, 불가능으로 설정됨. -> 인터럽트 요청 오더라도 무시.
- 다만 모든 하드웨어 인터럽트를 인터럽트 플래그로 막을 수는 없다. 막을 수 있는 인터럽트(maskable interrupt)와 막을 수 없는 인터럽트(non maskable interrupt)가
있다. 막을 수 없는 인터럽트는 가장 우선순위가 높은, 가장 먼저 처리해야 하는 인터럽트.
- CPU가 인터럽트 요청을 받아들이기로 했다면, 인터럽트 서비스 루틴(ISR; Interrupt Service Routine) 이라는 프로그램으로 인터럽트를 처리한다. 
인터럽트 핸들러 라고도 부름. 해당 인터럽트를 어떻게 처리하고 작동해야 할지에 대한 정보로 이루어진 프로그램.
- 'CPU가 인터럽트를 처리한다' == '인터럽트 서비스 루틴을 실행하고, 본래 수행하던 작업으로 다시 되돌아온다.'
- 수행 도중 인터럽트 발생한 경우의 과정
  1. 정상적으로 작업 진행
  2. 인터럽트 발생
  3. 인터럽트 서비스 루틴으로 점프
  4. 인터럽트 서비스 루틴 실행
  5. 기존 작업으로 점프
  6. 기존 작업 수행 재개
- 메모리에는 여러 개의 가기 가른 인터럽트 서비스 루틴이 저장되어 있다. 이는 인터럽트가 발생하면 어떻게 할지를 알려주는 프로그램.
- CPU는 수많은 인터럽트 서비스 루틴을 구분하기 위해 인터럽트 벡터를 이용. 인터럽트 벡터는 인터럽트 서비스 루틴을 식별하기 위한 정보. (시작 주소)
- CPU가 작업 수행 중 인터럽트 발생시, CPU는 인터럽트 벡터 참조 후 인터럽트 서비스 루틴의 시작 주소를 알아내고 실행해 나가며 인터럽트 서비스 루틴 실행.
- 'CPU가 인터럽트를 처리한다'=='인터럽트 서비스 루틴을 실행하고, 본래 수행하던 작업으로 다시 되돌아온다'
- 인터럽트 서비스 루틴도 명령어와 데이터로 이루어져 있어 프로그램 카운터를 비롯한 레지스터들을 사용하며 실행된다.
- 인터럽트 발생 전까지 레지스터에 저장되어 있던 값들은 사라질까? -> X, 인터럽트 서비스 루틴이 끝나면 되돌아와서 마저 수행해야 되므로, 어딘가에 백업을 해둬야 한다.
- 따라서 프로그램 카운터 값 등 현재 프로그램을 재개하기 위해 필요한 모든 내용을 스택에 백업. 그러고 나서, 인터럽트 서비스 루틴의 시작 주소가 위치한 곳으로 프로그램
카운터 값을 갱신하고 인터럽트 서비스 루틴을 실행함. 인터럽트 서비스 루틴을 모두 실행 후 스택에 저장된 값을 다시 불러와 작업 재개.
- 키워드 정리
  - 인터럽트 요청 신호 : CPU의 작업을 방해하는 인터럽트에 대한 요청
  - 인터럽트 플래그 : 인터럽트 요청 신호를 받아들일지 무시할지를 결정하는 비트
  - 인터럽트 벡터 : 인터럽트 서비스 루티의 시작 주소를 포함하는 인터럽트 서비스 루틴의 식별 정보
  - 인터럽트 서비스 루틴 : 인터럽트를 처리하는 프로그램

## 예외의 종류
- 예외의 종류에는 폴트, 트랩, 중단, 소프트웨어 인터럽트가 있다. 
- 예외가 발생하면 CPU는 하던 일을 중단하고 해당 예외를 처리. 처리 후 본래 하던 작업으로 되돌아와 실행 재개.
- 여기서 예외가 발생한 명령어의 다음 명령어부터 실행하느냐에 따라 폴트와 트랩으로 나뉨.
- 폴트는 예외 처리 직후 예외가 발생한 명령어부터 실행 재개하는 예외.
- 트랩은 예외 처리 직후 예외가 발생한 명령어의 다음 명령어부터 실행을 재개하는 예외. 주로 디버깅할 때 사용.
  - 디버깅이란 프로그램 개발 중에 발생한 문제를 진단하고 해결하기 위한 작업.
- 트랩 처리 후, 즉, 프로그램 중단시키고 디버깅이 끝나면 프로그램은 다음 명령어부터 실행을 이어나가면 된다.
- 중단은 CPU가 실행 중인 프로그램을 강제로 중단시킬 수밖에 없는 심각한 오류를 발견했을 때 발생하는 예외.
- 소프트웨어 인터럽트는 시스템 호출이 발생했을 때 나타난다.

## 키워드 정리
- 명령어 사이클은 하나의 명령어가 처리되는 주기로, 인출, 실행, 간접, 인터럽트 사이클로 구성됨.
- 인터럽트는 CPU의 정상적인 작업을 방해하는 신호.
- 인터럽트의 종류에는 예외와 하드웨어 인터럽트가 있다.
- 인터럽트 서비스 루틴은 인터럽트를 처리하기 위한 동작들로 이루어진 프로그램.

