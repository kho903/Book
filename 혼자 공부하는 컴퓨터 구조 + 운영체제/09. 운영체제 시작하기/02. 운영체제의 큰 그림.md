# 09-2. 운영체제의 큰 그림
- 운영체제는 사용자를 위한 프로그램이 아닌 사용자가 실행하는 프로그램을 위한 프로그램. 즉, 응용 프로그램이 올바르게 실행되도록 돕고 필요한 자원을 할당해 주는 프로그램.
- 운영체제에서 중요한 커널과 응용 프로그램이 운영체제로부터 어떻게 도움을 받으며 실행되는지 이해를 위한 이중 모드, 시스템 호출. 운영체제가 응용 프로그램에 제공하는 서비스 종류.

## 운영체제의 심장, 커널
- 운영체제는 현존하는 프로그램 중 규모가 가장 큰 프로그램. 응용 프로그램에 제공하는 기능들, 즉, 운영체제 서비스 또한 매우 다양.
- 가장 핵심적인 서비스들이 있는데, 자원에 접근하고 조작, 프로그램이 올바르고 안전하게 실행되게 하는 기능 등이 속함. 이 핵심 서비스 담당 부분을 커널(kernel)이라고 한다.
- 운영체제가 설치된 모든 기기에는 커널이 있다. 어떤 커널인지에 따라 하드웨어 이용 양상 및 컴퓨터 성능도 달라짐.
- 운영체제가 제공하는 서비스 중 커널에 포함되지 않는 서비스는 대표적으로 사용자 인터페이스(UI; User Interface)는 사용자가 컴퓨터와 상호작용할 수 있는 통로.
- 사용자 인터페이스의 종류에는 그래픽 유저 인터페이스(GUI;Graphic User Interface)와 커맨드 라인 인터페이스(CLI;Command Line Interface)가 있다.
- GUI는 바탕화면 같은 그래픽 기반으로 컴퓨터와 상호작용할 수 있는 인터페이스, CLI는 명령어를 기반으로 컴퓨터와 상호작용할 수 있는 인터페이스.
- 이러한 사용자 인터페이스는 운영체제가 제공하는 서비스이지만, 이는 그저 컴퓨터와 상호작용하기 위한 통로일 뿐 커널에 속한 기능은 아니다. 실제로 같은 커널을 사용하더라도 사용자
인터페이스는 다를 수 있다.

## 이중 모드와 시스템 호출
- 운영체제는 사용자가 실행하는 응용 프로그램이 하드웨어 자원에 직접 접근하는 것 방지하여 자원을 보호. 
- 운영체제는 응용 프로그램들이 자원애 접근려고 할 때 오직 자신을 통해서만 접근하도록 자원 보호. 응용 프로그램이 자원에 접근하기 위해서는 운영체제에 도움을 요청해야 하는데, 이때,
'운영체제에 도움을 요청한다'는 말은 '운영체제 코드를 실행하려고 한다'라는 말과 같다. 응용 프로그램의 요청을 받은 운영체제는 응용 프로그램 대신 자원에 접근하여 요청한 작업 수행.
- 이러한 운영체제의 문지기 역할은 이중모드로써 구현되는데, 이중 모드(dual mode)란 CPU가 명령어를 실행하는 모드를 크게 사용자 모드와 커널 모드로 구현하는 방식. CPU는 이 두 모드로
명령어를 실행 가능.
- 사용자 모드(user mode)는 운영체제 서비스를 제공받을 수 없는 실행 모드. 즉, 커널 영역의 코드 실행 불가. 일반적으로 응용 프로그램은 사용자 모드로 실행됨. 사용자 모드로 실행중인
CPU는 하드웨어 자원에 접근하는 명령어 실행 불가. 즉, 사용자 모드로 실행된 응용 프로그램은 자원에 접근 불가.
- 커널 모드(kernel mode)는 운영체제 서비스를 제공받을 수 있는 실행 모드. 즉, 커널 영역어 코드 실행 가능. 자원에 접근하는 명령어를 비롯한 모든 명령어 실행 가능. 운영체제는 커널
모드로 실행되어 자원에 접근 가능.
  - CPU가 사용자 모드 / 커널 모드로 실행 중인지는 플래그 레지스터 속 슈퍼바이저 플래그를 보면 알 수 있다.
- 사용자 모드로 실행되는 프로그램이 자원에 접근하는 운영체제 서비스 제공받으려면 운영체제에 요청을 보내 커널 모드로 전환되어야 한다. 저 요청을 시스템 호출(system call)이라고 한다.
- 시스템 호출은 일종의 소프트웨어적인 인터럽트. 입출력장치에 의해 발생되기도 하지만 특정 명령어에 의해 발생하기도 하는데, 이를 소프트웨어 인터럽트라고 한다.
- 그래서 CPU가 시스템 호출을 처리하는 순서는 인터럽트 처리 순서와 유사. 시스템 호출 발생 명령어 실행시 CPU는 지금까지 작업 백업 -> 커널 영역 내 시스템 호출 수행 코드(인터럽트
서비스 루틴) 실행 -> 다시 기존 실행 응용 프로그램으로 복귀 후 실행.
- 일반적으로 응용 프로그램은 실행 과정에서 운영체제 서비스들을 매우 빈번히 사용. 그 과정에서 빈번하게 시스템 호출 발생 시켜 사용자 모드와 커널 모드를 오가며 실행된다.

## 운영체제의 핵심 서비스
- 운영체제의 핵심 서비스는 프로세스 관리, 자원 접근 및 할당, 파일 시스템 관리.

### 프로세스 관리
- 실행 중인 프로그램을 프로세스(process)라고 한다. 우리가 컴퓨터를 사용하는 동안 메모리 안에서는 새로운 프로세스들이 마구 생성되고 삭제된다.
- 일반적으로 하나의 CPU는 한 번에 하나의 프로세스만 실행할 수 있기에 CPU는 이 프로세스들을 번갈아 실행. 이떄 각 프로세스는 상태도, 사용하고자 하는 자원도 다양.
- 프로세스별로 입출력장치를 주로 사용하거나 거의 사용하지 않고 CPU만 사용한다던가, 당장 실행 가능하다거나, 당장 실행이 불가능하다는 등 다양하다. 그래서 운영체제는 다양한 프로세스를
일목요연하게 관리하고 실행할 수 있어야 한다.
- 추가로 여러 프로세스가 동시에 실행되는 환경에서는 '프로세스 동기화'가 필수적이고, 프로세스가 꼼짝도 못하고 더 이상 실행되지 못하는 상황인 '교착 상태'를 해결한다.

### 자원 접근 및 할당
- 모든 프로세스는 실행을 위한 자원이 필요, 운영체제는 프로세스들이 사용할 자원에 접근, 조작하여 할당한다. 운영체제가 CPU, 메모리, 입출력장치를 어떻게 관리하고 어떤 기능을 제공할까?

#### CPU
- 일반적으로 메모리에는 여러 프로세스가 적재, 하나의 CPU는 한 번에 하나의 프로세스만 실행 가능. 그래서 한 프로세스가 CPU 이용 중, 다른 프로세스는 기다려야 한다.
- 이에 운영체제는 프로세스들에 공정하게 CPU를 할당하기 위해 어떤 프로세스부터 CPU를 이용하게 할 것인지, 얼마나 오래 CPU를 이용하게 할지 결정할 수 있어야 하는데, 이를 CPU
스케줄링 이라고 한다.

#### 메모리
- 메모리에 적재된 프로세스들은 크기도, 적재되는 주소도 가지각색. 그래서 운영체제는 새로운 프로세스가 적재될 때마다 어느 주소에 적재해야 할지 결정해야 함.
- 때로는 메모리가 이미 꽉 차 있어 꼭 실행할 프로세스를 적재할 공간이 없는 경우도 있고, 메모리에 공간이 남았는 데도 불구하고 프로세스를 적재하지 못하는 상황도 발생.

#### 입출력장치
- 인터럽트 서비스 루틴은 운영체제가 제공하는 기능으로 커널 영역에 있다. 입출력장치가 발생시키는 하드웨어 인터럽트도 마찬가지. 입출력장치가 CPU에 하드웨어 인터럽트 요청 신호를 보내면
CPU는 하던 일을 잠시 백업한 뒤 커널 영역에 있는 인터럽트 서비스 루틴을 실행한다. 이처럼 운영체제는 인터럽트를 처리하는, 즉 인터럽트 서비스 루틴을 제공함으로써 입출력 작업 수행.

### 파일 시스템 관리
- 여러 파일을 열고, 생성하고, 삭제하고 묶어 디렉터리로 관리한다. 이런 파일 시스템(file system)도 운영체제가 지원하는 핵심 서비스. 

## 정리
- 운영체제의 핵심 서비스를 제공하는 부분은 커널.
- 사용자 프로세스가 커널의 서비스를 제공받기 위해서는 (커널 영역의 코드를 실행하기 위해서는) 사용자 모드에서 커널 모드로 전환해야 하고, 이는 시스템 호출을 통해 이루어진다.
- 즉, 시스템 호출은 커널모드로써 운영체제의 서비스를 제공받을 수 있는 방법.
- 대표적인 커널의 서비스로는 프로세스 관리, 자원 접근 및 할당, 파일 시스템 관리가 있다.

## 가상 머신과 이중 모드의 발전
- 이중 모드는 커널 모드와 사용자 모드, 두 가지 모드를 지원하는 실행 모드이지만, 가상 머신을 통한 가상화를 지원하는 현대 CPU는 두 가지 모드 이상을 지원.
- 가상 머신(virtual machine)이란 이름 그대로 소프트웨어적으로 만들어낸 가상 컴퓨터. 가상 머신을 설치하면 새로운 운영체제와 응용 프로그램을 설치, 실행 가능.
- 가상 머신 또한 사용자 모드로 작동하는데, 따라서 가상 머신상에 설치된 운영체제 또한 사용자 모드로 작동한다. 가상 머신에 설치된 응용 프로그램이 운영체제 서비스를 제공받기 위해
하이퍼 바이저 모드라는 가상 머신을 위한 모드가 따로 있다. 이로써 가상 머신 상에서 작동하는 응용 프로그램들은 하이퍼바이저 모드로써 가상 머신에 설치된 응용 프로그램으로부터 운영체제
서비스를 받을 수 있다.

## 시스템 호출의 종류
### 프로세스 관리 시스템 호출
| 시스템 호출    | 설명                                   |
|-----------|--------------------------------------|
| fork()    | 새 자식 프로세스 생성                         |
| execve()  | 프로세스 실행(메모리 공간을 새로운 프로그램의 내용으로 덮어씌움) |
| exit()    | 프로세스 종료                              |
| waitpid() | 자식 프로세스가 종료할 때까지 대기                  |

### 파일 관리 시스템 호출
| 시스템 호출  | 설명       |
|---------|----------|
| open()  | 파일 열기    |
| close() | 파일 닫기    |
| read()  | 파일 읽기    |
| write() | 파일 쓰기    |
| stat()  | 파일 정보 획득 |

### 디렉터리 관리
| 시스템 호출  | 설명            |
|---------|---------------|
| chdir() | 작업 디렉터리 변경    |
| mkdir() | 디렉터리 생성       |
| rmdir() | 비어 있는 디렉터리 삭제 |

### 파일 시스템 관리
| 시스템 호출   | 설명            |
|----------|---------------|
| mount()  | 파일 시스템 마운트    |
| umount() | 파일 시스템 마운트 해제 |

- 개발자가 작성하는 프로그래밍 언어들은 내부적으로 위와 같은 시스템 호출을 통해 실행된다.
- 운영체제는 제공하는 서비스가 매우 다양하기에 시스템 호출의 종류도 다양하다.

## 키워드 정리
- 커널은 운영체제의 핵심 기능을 담당.
- 이중 모드는 CPU가 명령어를 실행하는 모드를 커널 모드와 사용자 모드로 구분하는 방식.
- 시스템 호출은 운영체제의 서비스를 제공받기 위해 커널 모드로 전환하는 방법.
- 대표적인 운영체제 서비스로 프로세스 관리, 자원 접근 및 할당, 파일 시스템 관리가 있다.
